<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Pragma" content="no-cache">
    <title>Dispatchers</title>
    <style type="text/css">
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .task-cancelled {
            border-color: #6f670f !important;
            background: #ffffff; /* Old browsers */
            background: -moz-linear-gradient(top, #ffffff 0%, #f1f1f1 50%, #e1e1e1 51%, #f6f6f6 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #ffffff 0%,#f1f1f1 50%,#e1e1e1 51%,#f6f6f6 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #ffffff 0%,#f1f1f1 50%,#e1e1e1 51%,#f6f6f6 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#f6f6f6',GradientType=0 );
        }

        .task-pending {
            border-color: #6f670f !important;
            background: #ffffff; /* Old browsers */
            background: -moz-linear-gradient(top, #ffffff 0%, #f1f1f1 50%, #e1e1e1 51%, #f6f6f6 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #ffffff 0%,#f1f1f1 50%,#e1e1e1 51%,#f6f6f6 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #ffffff 0%,#f1f1f1 50%,#e1e1e1 51%,#f6f6f6 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#f6f6f6',GradientType=0 );
        }

        .task-active {
            border-color: #006bff !important;
            background: #3b679e; /* Old browsers */
            background: -moz-linear-gradient(top, #3b679e 0%, #2b88d9 50%, #207cca 51%, #7db9e8 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #3b679e 0%,#2b88d9 50%,#207cca 51%,#7db9e8 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #3b679e 0%,#2b88d9 50%,#207cca 51%,#7db9e8 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#3b679e', endColorstr='#7db9e8',GradientType=0 );
        }

        .task-completed {
            border-color: #0c6b08 !important;
            background: #bfd255; /* Old browsers */
            background: -moz-linear-gradient(top, #bfd255 0%, #8eb92a 50%, #72aa00 51%, #9ecb2d 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #bfd255 0%,#8eb92a 50%,#72aa00 51%,#9ecb2d 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #bfd255 0%,#8eb92a 50%,#72aa00 51%,#9ecb2d 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#bfd255', endColorstr='#9ecb2d',GradientType=0 );
        }

        .task-failed {
            border-color: #880000 !important;
            background: #f85032; /* Old browsers */
            background: -moz-linear-gradient(top, #f85032 0%, #f16f5c 50%, #f6290c 51%, #f02f17 71%, #e73827 100%); /* FF3.6-15 */
            background: -webkit-linear-gradient(top, #f85032 0%,#f16f5c 50%,#f6290c 51%,#f02f17 71%,#e73827 100%); /* Chrome10-25,Safari5.1-6 */
            background: linear-gradient(to bottom, #f85032 0%,#f16f5c 50%,#f6290c 51%,#f02f17 71%,#e73827 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#f85032', endColorstr='#e73827',GradientType=0 );
        }
    </style>
</head>
<body>
    <div class="Title">
        <h1>Dispatcher</h1>
    </div>
    <div id="visualization">
        <div class="menu">
            <input type="button" id="fit" value="Fit" />
            <input type="button" id="toggleRollingMode" value="Follow" />
        </div>
    </div>
    <div id="taskDetail">
        <div class="name"></div>
        <div class="data"></div>
    </div>

    <!--Script references. -->
    <script src="scripts/jquery-1.6.4.min.js"></script>
    <script src="scripts/jquery.signalR-2.2.3.min.js"></script>

    <script src="scripts/vis/vis.js"></script>
    <link href="scripts/vis/vis.min.css" rel="stylesheet" type="text/css" />
    <style type="text/css">

        #vizualization {
            position: relative;
        }

        .menu {
            position: absolute;
            top: 0;
            right: 0;
            margin: 10px;
            z-index: 9999;
        }

            .menu input {
                background: transparent;
                border: 2px solid black;
            }

        .vis-item.vis-range {
            border-radius: 5px !important;
            height: 16px;
        }
    </style>

    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:9010/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            $.connection.hub.url = "http://localhost:9010/signalr";
            var monitor = $.connection.monitorHub;

            const activeSet = new Set();
            const startTime = Date.now();
            const pixelsPerSecond = 0.01;
            const taskSpacingPx = 10;
            var nextTaskId = 1;
            var nextGroupId = 1;
            var agents = {};
            var agentTasks = {};
            var agentTaskTimelineIds = {};
            var selectedTaskId = 0;

            var container = document.getElementById('visualization');
            var items = new vis.DataSet([]);
            var groups = new vis.DataSet([
                { id: "dead", content: 'Dead Agents', nestedGroups: [] }
            ]);

            var options = {
                start: Date.now(),
                end: Date.now() + 1000 * 100,
                align: 'left',
                min: Date.now(),
                minHeight: '200px',
                zoomMax: 1000 * 60 * 60 * 24 * 2,
                //rollingMode: { follow: false, offset: 0.5 }
            };
            var timeline = new vis.Timeline(container, items, groups, options);

            //monitor.client.setJob = function (name, priority, config, taskCount) {
            //    $('#job').empty();
            //    $('#job').append("<div>Name:" + name + "</div>");
            //    $('#job').append("<div>Priority:" + priority + "</div>");
            //    $('#job').append("<div>Config:" + config + "</div>");
            //    $('#job').append("<div>TaskCount:" + taskCount + "</div>");
            //};

            monitor.client.addAgent = function (name, endpoint) {
                var agent = agents[name];
                if (!agent) {
                    agent = {
                        groupId: nextGroupId++,
                        endpoint: endpoint,
                        capacity: 0
                    };

                    agents[name] = agent;
                    groups.add({ id: agent.groupId, content: '<a href="http://' + agent.endpoint + '">Agent</a>' });
                }
            };

            monitor.client.removeAgent = function (name) {
                var agent = agents[name];
                if (agent) {
                    var nestedGroups = groups.get("dead").nestedGroups;
                    nestedGroups.push(agent.groupId);
                    groups.update({ id: "dead", nestedGroups: nestedGroups });
                    timeline.setGroups(groups);

                    delete agents[name];
                }
            };

            monitor.client.setAgentCapacity = function (name, capacity) {
                var agent = agents[name];
                if (!agent) {
                    return;
                }

                agent.capacity = capacity;

                groups.update({
                    id: agent.groupId,
                    content: '<a href="http://' + agent.endpoint + '">Agent</a> (' + capacity + ' threads)',
                    title: name
                });
            };

            monitor.client.updateTask = function (name, state, tasks) {
                var agent = agents[name];
                if (!agent) {
                    return;
                }

                for (var i in tasks) {
                    var taskItem = tasks[i];
                    var taskName = taskItem.Identifier;
                    var task = agentTasks[taskName];

                    if (!task) {
                        task = {
                            agentId: name,
                            id: nextTaskId++,
                            startTime: Date.now(),
                            endTime: Date.now(),
                            taskName: taskName,
                            taskData: taskItem.Data
                        };
                        agentTasks[taskName] = task;
                        agentTaskTimelineIds[task.id] = task;

                        items.add({
                            id: task.id,
                            content: "",
                            title: taskName,
                            start: new Date(task.startTime),
                            group: agent.groupId,
                        });
                    }

                    if (state == 'active') {
                        activeSet.add(task.id);
                    } else {
                        activeSet.delete(task.id);
                    }

                    // remove tasks from the known task names
                    if (state == 'cancelled') {
                        delete agentTasks[taskName];
                        delete agentTaskTimelineIds[task.id];
                    }

                    items.update({ id: task.id, className: 'task-' + state });
                }
            };


            $('#fit').click(() => timeline.fit());
            $('#toggleRollingMode').click(() => {
                timeline.setOptions({ rollingMode: { offset: 0.5 } });
                timeline.toggleRollingMode();
            });

            timeline.on('select', function (properties) {
                var taskId = properties.items[0];
                var detail = $("#taskDetail");
                var name = detail.find('.name');
                var data = detail.find('.data');

                if (selectedTaskId && selectedTaskId != taskId) {
                    items.update({ id: selectedTaskId, style: "box-shadow:none" })
                }

                var task = agentTaskTimelineIds[taskId];
                if (task) {
                    name.text(task.taskName);
                    data.text(task.taskData);
                    items.update({ id: taskId, style: "box-shadow: rgb(35, 173, 278) 0 0 15px 3px" })
                } else {
                    name.text("");
                    data.text("");
                }

                selectedTaskId = taskId;
            });

            // Get the user name and store it to prepend to messages.
            //$('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {

                var updateActiveTasks = () => {
                    setTimeout(arguments.callee, 10);
                    activeSet.forEach(taskId => {
                        items.update({ id: taskId, end: Date.now() });
                    });
                };
                updateActiveTasks();


                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    monitor.server.send($('#displayname').val(), $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
    </script>
</body>
</html>